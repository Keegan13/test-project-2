@model IndexViewModel
@inject IIdentityService<User> identity;
@{

    ViewData["Title"] = "My chats";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string currUserId = identity.CurrentUserId;
    string selectedId = ViewBag.SelectedId as string;
    if (String.IsNullOrEmpty(selectedId))
    {
        selectedId = Model.Rooms.FirstOrDefault()?.Id ?? "";
        ViewBag.SelectedId = selectedId;
    }
}

<div class="row">
    <div class="col-md-4">
        <div>
            <nav class="chats-tabs">
                <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
                    @foreach (var item in Model.Rooms)
                    {
                        <a class="nav-item nav-link d-block w-100 chat-tab-link @(item.Id==selectedId?"active":"") @(item.HasUnread?"updated":"")" id="chat@(item.Id)-tab" data-toggle="tab" href="#chat@(item.Id)" role="tab" aria-controls="chat@(item.Id)" aria-selected="@(item.Id==selectedId?"true":"false")">
                            <i class="fa @(item.IsPrivate?"fa fa-user":"fa fa-users")"></i>
                            @item.RoomName
                        </a>
                    }
                    @foreach (var user in Model.Users)
                    {
                        <a class="nav-item nav-link d-block w-100 chat-tab-link" href="/" data-ajax="true" method="GET" data-ajax-success="onNewChatSuccess" data-ajax-url="@Url.Action("Private","Chat",new {  user.Id })">
                            <i class="fa fa-plus"></i>
                            @user.UserName
                        </a>
                    }

                </div>
            </nav>
        </div>
    </div>
    <div class="col-md-8">
        <div class="tab-content" id="nav-tabContent">
            @foreach (var item in Model.Rooms)
            {
                <div class="tab-pane fade @(item.Id==selectedId?"show active":"")" id="chat@(item.Id)" role="tabpanel" aria-labelledby="chat@(item.Id)-tab">
                    <partial name="_chatTab" model="@item" />
                </div>
            }
        </div>
    </div>
</div>

<div id="hidden"></div>

@section Scripts{
    <script>
        function onComplete() {
            $("form input[name=text]").val("")
        }
    </script>
    <script>
        (function ($) {

            let _showHasNewMessages = function (id) {
                var element = $(`a#chat${id}-tab`);
                if (element && !element.hasClass("active")) {
                    element.addClass("updated");
                }
            };

            let _appendMessage = function (msg) {
                msg.sendDate = moment(new Date(msg.sendDate)).format("YYYY-MM-DD hh:mm");
                const container = $("#chat" + msg.chatRoomId + " .chat-messages");
                let senderCls = $.currentUserId === msg.senderId ? 'outcomming' : 'incomming';

                $(`<div class="alert alert-primary ${senderCls}" role="alert"><p>${msg.text}</p><hr><p class="message-info"><span class="message-date">${msg.sendDate}</span> ${msg.senderUserName}</p></div>`).appendTo(container);

                container.scrollTop(100000);
            };

            let _appendChat = function (chat) {
                const tabContainer = $("#nav-tabContent");
                const tabLinkContainer = $("#nav-tab");

                if ($(`#chat${chat.id}`).length > 0||$(`#chat${chat.id}-tab`).length > 0) {
                    return;
                }

                //MAINTANCE HELL
                $(`<div class="tab-pane fade" id="chat${chat.id}" role="tabpanel" aria-labelledby="chat${chat.id}-tab"><div class="mb-3 mt-2"><h4 class="chat-heading d-inline-block align-middle">${chat.roomName}</h4><a data-ajax="true" class="btn btn-primary btn-invite d-inline-block align-middle float-right" data-ajax-success="partialModal" data-ajax-method="GET" data-ajax-url="/Chat/Invite/${chat.id}"><i class="fa fa-plus-circle"></i></a></div><div class="chat-messages"></div><form method="post" data-ajax="true" data-ajax-method="post" data-ajax-url="/Chat/Sent" data-ajax-success="onMessageSent" class="mt-2"><div class="input-group"><input type="hidden" name="roomid" value="${chat.id}"/><textarea class="form-control" name="text" value="" placeholder="Type a message" required></textarea><button type="submit" class="btn"><i class="fa fa-telegram" style="font-size:36px;color:cornflowerblue"></i></button></div></form></div>`)
                    .appendTo(tabContainer);

                $(`<a class="nav-item nav-link d-block w-100 chat-tab-link" id="chat${chat.id}-tab" data-toggle="tab" href="#chat${chat.Id}" role="tab" aria-controls="chat${chat.id}" aria-selected="false"><i class="fa fa-user"></i> ${chat.roomName}</a>`).prependTo(tabLinkContainer);
            };

            let _userJoinAlert = function (userJoin) {
                alert(`User ${userJoin.user.userName} has joined to chat room ${userJoin.chatName}`);
            };

            let _onMessageHandler = function (msg) {
                if (msg == null || msg == "" || msg == undefined) {
                    return;
                }

                _appendMessage(msg);
                _showHasNewMessages(msg.chatRoomId);
            };

            let _onNewChatHandler = function (chat) {
                if (chat == null || chat == "" || chat == undefined) {
                    return;
                }
                _appendChat(chat);
            };

            let _onChatJoinHandler = function (user) {
                if (user == null || user == "" || user == undefined) {
                    return;
                }
                _userJoinAlert(user);
            };

            const config = {
                host: "/Hub",
                onMessage: _onMessageHandler,
                onNewChat: _onNewChatHandler,
                onChatJoin:_onChatJoinHandler,
                mode: "null"
            };
            $("#hidden").hub(config);
            $.currentUserId = "@identity.CurrentUserId";

            $("form textarea").keypress(function (e) {
                if (e.which == 13 && !e.shiftKey&&this.value.match(/[^\w\.\-]/)) {
                    e.preventDefault();
                    $(this).submit();
                }
                else {
                    e.shiftKey = false;
                }
    });

        })(jQuery)

    </script>
}
